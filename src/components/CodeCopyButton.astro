---
// This component adds copy buttons to all code blocks on the page
---

<script>
  function addCopyButtons() {
    const codeBlocks = document.querySelectorAll('pre:has(code)');

    codeBlocks.forEach((pre) => {
      // Skip if already has a copy button
      if (pre.querySelector('.copy-button')) return;

      // Create wrapper for positioning
      const wrapper = document.createElement('div');
      wrapper.className = 'relative group';
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      // Create copy button using safe DOM methods
      const button = document.createElement('button');
      button.className = 'copy-button absolute top-2 right-2 p-2 rounded-lg bg-slate-700/50 hover:bg-slate-600/50 text-slate-300 hover:text-white opacity-0 group-hover:opacity-100 transition-all duration-200';
      button.setAttribute('aria-label', 'Copy code');

      // Create copy icon SVG
      const copyIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      copyIcon.setAttribute('class', 'copy-icon w-4 h-4');
      copyIcon.setAttribute('fill', 'none');
      copyIcon.setAttribute('viewBox', '0 0 24 24');
      copyIcon.setAttribute('stroke', 'currentColor');
      const copyPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      copyPath.setAttribute('stroke-linecap', 'round');
      copyPath.setAttribute('stroke-linejoin', 'round');
      copyPath.setAttribute('stroke-width', '2');
      copyPath.setAttribute('d', 'M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z');
      copyIcon.appendChild(copyPath);

      // Create check icon SVG
      const checkIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      checkIcon.setAttribute('class', 'check-icon w-4 h-4 hidden');
      checkIcon.setAttribute('fill', 'none');
      checkIcon.setAttribute('viewBox', '0 0 24 24');
      checkIcon.setAttribute('stroke', 'currentColor');
      const checkPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      checkPath.setAttribute('stroke-linecap', 'round');
      checkPath.setAttribute('stroke-linejoin', 'round');
      checkPath.setAttribute('stroke-width', '2');
      checkPath.setAttribute('d', 'M5 13l4 4L19 7');
      checkIcon.appendChild(checkPath);

      button.appendChild(copyIcon);
      button.appendChild(checkIcon);

      button.addEventListener('click', async () => {
        const code = pre.querySelector('code');
        if (!code) return;

        const text = code.textContent || '';

        try {
          await navigator.clipboard.writeText(text);

          // Show success state
          const copyIcon = button.querySelector('.copy-icon');
          const checkIcon = button.querySelector('.check-icon');
          copyIcon?.classList.add('hidden');
          checkIcon?.classList.remove('hidden');
          button.classList.add('bg-accent-600/50');

          setTimeout(() => {
            copyIcon?.classList.remove('hidden');
            checkIcon?.classList.add('hidden');
            button.classList.remove('bg-accent-600/50');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });

      wrapper.appendChild(button);
    });
  }

  // Run on page load
  addCopyButtons();

  // Re-run after view transitions (if using)
  document.addEventListener('astro:after-swap', addCopyButtons);
</script>
