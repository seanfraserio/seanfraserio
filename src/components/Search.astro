---
// Pagefind search component
---

<div id="search-container" class="relative">
  <button
    id="search-button"
    type="button"
    class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
    aria-label="Search"
  >
    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>
    <span class="hidden sm:inline">Search</span>
    <kbd class="hidden sm:inline-flex items-center gap-1 px-1.5 py-0.5 text-xs bg-slate-200 dark:bg-slate-700 rounded">
      <span class="text-xs">âŒ˜</span>K
    </kbd>
  </button>
</div>

<!-- Search Modal -->
<div id="search-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm" id="search-backdrop"></div>
  <div class="fixed inset-x-2 sm:inset-x-4 top-4 sm:top-8 mx-auto max-w-2xl max-h-[90vh] overflow-hidden">
    <div class="bg-white dark:bg-slate-900 rounded-xl shadow-2xl border border-slate-200 dark:border-slate-700 overflow-hidden max-h-[85vh] flex flex-col">
      <div id="search-content" class="p-3 sm:p-4 overflow-y-auto flex-1">
        <!-- Pagefind UI will be mounted here -->
      </div>
    </div>
  </div>
</div>

<style is:global>
  /* Pagefind UI customization */
  :root {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-primary: #3b82f6;
    --pagefind-ui-text: #1e293b;
    --pagefind-ui-background: #ffffff;
    --pagefind-ui-border: #e2e8f0;
    --pagefind-ui-tag: #f1f5f9;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 8px;
    --pagefind-ui-font: inherit;
  }

  .dark {
    --pagefind-ui-primary: #60a5fa;
    --pagefind-ui-text: #f1f5f9;
    --pagefind-ui-background: #0f172a;
    --pagefind-ui-border: #334155;
    --pagefind-ui-tag: #1e293b;
  }

  .pagefind-ui__search-input {
    font-size: 1rem !important;
  }

  .pagefind-ui__result-link {
    color: var(--pagefind-ui-primary) !important;
  }
</style>

<script>
  // Search functionality - Pagefind loads dynamically after build
  document.addEventListener('DOMContentLoaded', () => {
    let pagefindUI: any = null;
    let cssLoaded = false;

    function loadPagefindCSS() {
      if (cssLoaded) return;
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = '/pagefind/pagefind-ui.css';
      document.head.appendChild(link);
      cssLoaded = true;
    }

    async function initPagefind() {
      if (pagefindUI) return;

      try {
        loadPagefindCSS();

        // Load pagefind-ui.js via script tag if not already loaded
        if (!(window as any).PagefindUI) {
          await new Promise<void>((resolve, reject) => {
            const script = document.createElement('script');
            script.src = '/pagefind/pagefind-ui.js';
            script.onload = () => resolve();
            script.onerror = () => reject(new Error('Failed to load Pagefind'));
            document.head.appendChild(script);
          });
        }

        pagefindUI = new (window as any).PagefindUI({
          element: '#search-content',
          showSubResults: true,
          showImages: false,
        });
      } catch (e) {
        console.error('Pagefind error:', e);
        const content = document.getElementById('search-content');
        if (content) {
          content.innerHTML = '<p class="text-slate-500 dark:text-slate-400 text-center py-8">Search is available after building the site.<br/>Run <code class="bg-slate-100 dark:bg-slate-800 px-2 py-1 rounded">npm run build</code> to enable.</p>';
        }
      }
    }

    const modal = document.getElementById('search-modal');
    const button = document.getElementById('search-button');
    const backdrop = document.getElementById('search-backdrop');

    function openSearch() {
      modal?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      initPagefind().then(() => {
        const input = document.querySelector('.pagefind-ui__search-input') as HTMLInputElement;
        input?.focus();
      });
    }

    function closeSearch() {
      modal?.classList.add('hidden');
      document.body.style.overflow = '';
    }

    button?.addEventListener('click', openSearch);
    backdrop?.addEventListener('click', closeSearch);

    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        openSearch();
      }
      if (e.key === 'Escape') {
        closeSearch();
      }
    });
  });
</script>
